<!DOCTYPE html>
<!--The code is modified from: https://jasonneylon.wordpress.com/2013/09/05/two-sided-horizontal-barchart-using-d3-js/-->


<html>
<head>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
   <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>

    <title>Bar Chart</title>

    <style type="text/css">
        .chart {
            margin: 10px;
            padding-top: 10px;
        }

        .chart svg g .row text { 
            display: none; 
        }

        .right {
            width: 45%;
            position: absolute;
            right: 0;
        }

        .left {
            width: 45%;
            position: absolute;
            left: 0;
            transform: scale(-1,1);
        }

        .left text {
            transform: scale(-1,1);
        }

    </style>
</head>
<body>
<h1>Two sided horiztontal bar chart</h1>

<div id="worldMap" class="chart" style="height: 350px; width: 500px"></div>

<div id="grossChart" class="chart left"></div>

<div id="hdiChart" class="chart right"></div>

<div id="grossReligionChart" class="chart" style="margin-top: 500px;"></div>

<script type="text/javascript">
var dataByCountry = d3.map();
var grossByCountry = d3.map();

var facts;

var movieDim;
var countryDim;
var religionDim;

var all;
var treated_data = [];
var religion_amt = 8;

//Create a quantize color scale here
// Consider that the unemployment rate goes from 0 to 15% (.15)
// display the colors in nine different levels of greens (using colorbrewer)

var chartHdi = dc.rowChart("#hdiChart");
var chartGross = dc.rowChart("#grossChart");

//var worldMap = dc.geoChoroplethChart('#wordMap');

var chartGrossReligion = dc.scatterPlot("#grossReligionChart");

var movieGrossReligionGroup;

queue()
    // .defer(d3.tsv, "data/2016_general.csv")
    
    .defer(d3.tsv, 'data/2016_foreign.csv') 
    .defer(d3.tsv, "data/2016_countries.csv", 
      function(d) { dataByCountry.set(d.Name, {chr: parseFloat(d.ChristianPercent),
                                                   mus: parseFloat(d.MuslimPercent),
                                                   ath: parseFloat(d.AtheistPercent),
                                                   hin: parseFloat(d.HinduPercent),
                                                   bud: parseFloat(d.BuddhistPercent),
                                                   flk: parseFloat(d.FolkReligionPercent),
                                                   oth: parseFloat(d.OtherPercent),
                                                   jew: parseFloat(d.JewishPercent),
                                                   hdi: parseFloat(d.HDI),
                                                   population: +d.Population
                                               }
                                              );})
    .await(ready);

function ready(error, data) {

    // data.forEach(function(d) {
    //     var country_info = dataByCountry.get(d.Country);

    //     d.hdi = country_info.hdi;
    //     d.population = country_info.population;

    //     d.chr_value = country_info.chr;
    //     d.mus_value = country_info.mus;
    //     d.ath_value = country_info.ath;
    //     d.hin_value = country_info.hin;
    //     d.bud_value = country_info.bud;
    //     d.flk_value = country_info.flk;
    //     d.jew_value = country_info.jew;
    //     d.oth_value = country_info.oth;
        
    //     d.rel_total = country_info.chr 
    //                 + country_info.mus 
    //                 + country_info.ath
    //                 + country_info.hin
    //                 + country_info.bud
    //                 + country_info.flk
    //                 + country_info.jew
    //                 + country_info.oth;
    // });

    // facts = crossfilter(data);

    //uncomment bellow and comment above for test with religions:

    data.forEach(function(d) {
        var country_info = dataByCountry.get(d.Country);
                
        var religions_names = Object.keys(country_info);
        var religions_values = Object.values(country_info);

        var index = religions_names.indexOf("hdi");

        religions_names.splice(index, 1);
        religions_values.splice(index, 1);

        index = religions_names.indexOf("population");

        religions_names.splice(index, 1);        
        religions_values.splice(index, 1);
        
        for(var i=0; i<religions_names.length; i++) {
            var tuple = Object.assign({}, d);
            
            tuple.religion = religions_names[i];
            tuple.religion_value = religions_values[i];
            tuple.hdi = country_info.hdi;
            tuple.population = country_info.population;
            
            treated_data.push(tuple);
        }
    });

    facts = crossfilter(treated_data);

    //all = facts.groupAll();

    //---------- Dimensions ---------------------------------

    movieDim = facts.dimension(function(d) {
        return d.Title;
    });

    countryDim = facts.dimension(function(d) {
        return d.Country;
    })

    religionDim = facts.dimension(function(d) {
        return d.religion;
    })

    console.log(movieDim.top(Infinity));

    //--------- Groups and Charts --------------------------------------

    // Rowchart: 

    var countryHdiMax = countryDim.group().reduceCount().top(1)[0].value;
    var totalCountryAmt = countryDim.group().reduceCount().top(Infinity).length;
    var countryAmt;

    var countryHdiGrossGroup = countryDim.group().reduce(function(n, d) {
        n.Total_Gross += parseFloat(d.Total_Gross);
        n.hdi += parseFloat(d.hdi);
        return n;
    }, function(n, d) {
        n.Total_Gross -= parseFloat(d.Total_Gross);
        n.hdi -= parseFloat(d.hdi);
        return n;
    }, function(){
        return {Total_Gross: 0, hdi: 0};
    });

    countryHdiGrossGroup.top(Infinity).forEach(function(d) {
        d.value.hdi = parseFloat((d.value.hdi / countryHdiMax).toFixed(2));
        //uncomment bellow for test with religions:
        d.value.Total_Gross = parseFloat((d.value.Total_Gross / religion_amt).toFixed(2));
    });

    chartGross
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {
            var top_10 = group.order(function(d) {return d.Total_Gross;}).top(10);
            countryAmt = top_10.length;
            return top_10;
        })
        .valueAccessor(function(d) {return d.value.Total_Gross})
        .height(countryAmt * 20)
        .gap(10);

    chartHdi
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(10);})
        .valueAccessor(function(d) {return d.value.hdi})
        .height(countryAmt * 20)
        .gap(10);


    // World Map:

    var map = L.map('worldMap');

    map.setView([40, 10],1);
    mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
    L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 15,
        }).addTo(map);

    //HeatMap
    /*var geoData = [];
    _.each(allDim.top(Infinity), function (d) {
        geoData.push([d["latitude"], d["longitude"], 1]);
    });
    var heat = L.heatLayer(geoData,{
        radius: 10,
        blur: 20, 
        maxZoom: 1,
    }).addTo(map);*/

    // Piechart:


    // Scatterplot:

    movieGrossReligionGroup = movieDim.group().reduce(function(n, d) {
        if(n.coords.length == 2) {
            n.coords[0] += parseFloat(d.Total_Gross);
            // n.coords[1] += parseFloat(d.chr_value) * parseFloat(d.Total_Gross) / 100;
            // n.coords[1] += parseFloat(d.rel_total) * parseFloat(d.Total_Gross) / 100;

            //uncomment bellow and comment above for test with religions:
            n.coords[1] += parseFloat(d.religion_value) * parseFloat(d.Total_Gross) / 100;
        } else {
            n.coords.push(parseFloat(d.Total_Gross));
            // n.coords.push(parseFloat(d.chr_value) * parseFloat(d.Total_Gross) / 100);
            // n.coords.push(parseFloat(d.rel_total) * parseFloat(d.Total_Gross) / 100);

            //uncomment bellow and comment above for test with religions:
            n.coords.push(parseFloat(d.religion_value) * parseFloat(d.Total_Gross) / 100);
        }
        return n;
    }, function(n, d) {
        if(n.coords == undefined) {
            n.coords = [0,0];
        } else {
            n.coords[0] += parseFloat(d.Total_Gross);
            n.coords[1] += parseFloat(d.religion_value) * parseFloat(d.Total_Gross) / 100;
        }

        return n;
    }, function(){
        return {coords: []};
    });

    // console.log(movieGrossReligionGroup.top(Infinity));

    // console.log(totalCountryAmt);

    movieGrossReligionGroup.top(Infinity).forEach(function(d, i, group) {
        var coords = d.value.coords;

        //uncomment bellow for test with religions:
        coords[0] = parseFloat(coords[0]/religion_amt).toFixed(2);
        coords[1] = parseFloat(coords[1]).toFixed(2);

        d.value = d.key;
        d.key = coords;

        // if(i === group.length - 1) {
        //     console.log(movieGrossReligionGroup.top(Infinity));
        // }
    });

    // // movieGrossReligionGroup.order(function(d) {return d.Title}).top(Infinity).forEach(function(d) {
        
    // //});

    // function toScatter(g, callback) {
    //     g.top(Infinity).forEach(function(d, i, group) {
    //         var coords = d.value.coords;

    //         //uncomment bellow for test with religions:
    //         coords[0] = parseFloat(coords[0]/religion_amt).toFixed(2);
    //         coords[1] = parseFloat(coords[1]).toFixed(2);

    //         d.value = d.key;
    //         d.key = coords;

    //         if(i == group.length - 1) {
    //             callback();
    //         }
    //     });
    // }

    chartGrossReligion
        .width(768)
        .height(480)
        .x(d3.scale.linear().domain([0.0,1200.0]))
        .y(d3.scale.linear().domain([0.0,1200.0]))
        .brushOn(false)
        //.symbolSize(8)
        //.clipPadding(10)
        //.yAxisLabel("This is the Y Axis!")
        .dimension(movieDim)
        .group(movieGrossReligionGroup);

    dc.renderAll();
}

$(document).ready(function() {
    $("#butt").click(function() {
        //console.log(movieGrossReligionGroup.top(Infinity));

        function f1(callback) {
            movieGrossReligionGroup.top(Infinity).forEach(function(d, i, group) {
                var coords = d.key;

                d.key = d.value;
                d.value = coords;

                if(i === group.length - 1) {
                    religionDim.filter(function(d) { return d != 'chr' });
                    callback();
                }
            });
        }

        f1(function() {
            movieGrossReligionGroup.top(Infinity).forEach(function(d, i, group) {
                var coords = d.value.coords;

                //uncomment bellow for test with religions:
                //coords[0] = parseFloat(coords[0]/religion_amt).toFixed(2);
                coords[0] = parseFloat(coords[0]).toFixed(2);
                coords[1] = parseFloat(coords[1]).toFixed(2);

                d.value = d.key;
                d.key = coords;

                if(i === group.length - 1) {
                    dc.redrawAll();
                }
            });
        });

        //console.log(movieGrossReligionGroup.top(Infinity));

        //religionDim.filter(function(d) { return d == 'chr' });
        //console.log(movieGrossReligionGroup.top(Infinity));
        // dc.redrawAll()
        
    })
})
// religionDim.filter(function(d) { return d == 'chr' }); dc.redrawAll()

</script>

<button id="butt">aplica filtro</button>
</body>
</html>