<!DOCTYPE html>
<!--The code is modified from: https://jasonneylon.wordpress.com/2013/09/05/two-sided-horizontal-barchart-using-d3-js/-->


<html>
<head>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
   <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>

    <title>Bar Chart</title>

    <style type="text/css">
        .chart {
            margin: 10px;
            padding-top: 10px;
        }

        .chart svg g .row text { 
            display: none; 
        }

        .right {
            width: 45%;
            position: absolute;
            right: 0;
        }

        .left {
            width: 45%;
            position: absolute;
            left: 0;
            transform: scale(-1,1);
        }

        .left text {
            transform: scale(-1,1);
        }

    </style>
</head>
<body>
<h1>Two sided horiztontal bar chart</h1>

<div id="worldMap" class="chart" style="height: 350px; width: 500px"></div>

<!-- <div id="grossChart" class="chart left"></div>

<div id="hdiChart" class="chart right"></div> -->

<div id="grossReligionChart" class="chart"></div>

<script type="text/javascript">
var dataByCountry = d3.map();
var grossByCountry = d3.map();

var facts;
var movieDim;
var all;
var treated_data;

//Create a quantize color scale here
// Consider that the unemployment rate goes from 0 to 15% (.15)
// display the colors in nine different levels of greens (using colorbrewer)

var chartHdi = dc.rowChart("#hdiChart");
var chartGross = dc.rowChart("#grossChart");

//var worldMap = dc.geoChoroplethChart('#wordMap');

//var chartGrossReligion = dc.scatterPlot("#grossReligionChart");

queue()
    // .defer(d3.tsv, "data/2016_general.csv")
    
    .defer(d3.tsv, 'data/2016_foreign.csv') 
    .defer(d3.tsv, "data/2016_countries.csv", 
      function(d) { dataByCountry.set(d.Name, {chr: parseFloat(d.ChristianPercent),
                                                   mus: parseFloat(d.MuslimPercent),
                                                   ath: parseFloat(d.AtheistPercent),
                                                   hin: parseFloat(d.HinduPercent),
                                                   bud: parseFloat(d.BuddhistPercent),
                                                   flk: parseFloat(d.FolkReligionPercent),
                                                   oth: parseFloat(d.OtherPercent),
                                                   jew: parseFloat(d.JewishPercent),
                                                   hdi: parseFloat(d.HDI),
                                                   population: +d.Population
                                               }
                                              );})
    .await(ready);

function ready(error, data) {

    data.forEach(function(d) {
        var country_info = dataByCountry.get(d.Country);

        d.hdi = country_info.hdi;
        d.chr_value = country_info.chr;
        d.mus_value = country_info.mus;
        d.ath_value = country_info.ath;
        d.hin_value = country_info.hin;
        d.bud_value = country_info.bud;
        d.flk_value = country_info.flk;
        d.jew_value = country_info.jew;
        d.oth_value = country_info.oth;
        d.population = country_info.population;
    });

    facts = crossfilter(data);
    all = facts.groupAll();

    //---------- Dimensions ---------------------------------

    var movieDim = facts.dimension(function(d) {
        return d.Title;
    });

    var countryDim = facts.dimension(function(d) {
        return d.Country;
    })

    //--------- Groups and Charts --------------------------------------

    // Rowchart: 

    var countryHdiMax = countryDim.group().reduceCount().top(1)[0].value;
    var countryAmt = countryDim.group().reduceCount().top(Infinity).length;

    var countryHdiGrossGroup = countryDim.group().reduce(function(n, d) {
        n.Total_Gross += parseFloat(d.Total_Gross);
        n.hdi += parseFloat(d.hdi);
        return n;
    }, function(n, d) {
        n.Total_Gross -= parseFloat(d.Total_Gross);
        n.hdi -= parseFloat(d.hdi);
        return n;
    }, function(){
        return {Total_Gross: 0, hdi: 0};
    });

    countryHdiGrossGroup.top(Infinity).forEach(function(d) {
        d.value.hdi = parseFloat((d.value.hdi / countryHdiMax).toFixed(2));
    });

    chartGross
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.Total_Gross})
        .height(countryAmt * 20)
        .gap(10);

    chartHdi
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.hdi})
        .height(countryAmt * 20)
        .gap(10);


    // World Map:

    var map = L.map('worldMap');

    map.setView([40, 10],1);
    mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';
    L.tileLayer(
        'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 15,
        }).addTo(map);

    //HeatMap
    /*var geoData = [];
    _.each(allDim.top(Infinity), function (d) {
        geoData.push([d["latitude"], d["longitude"], 1]);
    });
    var heat = L.heatLayer(geoData,{
        radius: 10,
        blur: 20, 
        maxZoom: 1,
    }).addTo(map);*/

    // Piechart:


    // Scatterplot:

    /*var movieGrossReligionGroup = movieDim.group().reduce(function(n, d) {
        n.Total_Gross += parseFloat(d.Total_Gross);
        n.Christian_Gross += parseFloat(d.chr_value) * parseFloat(d.Total_Gross) / 100;
        return n;
    }, function(n, d) {
        n.Total_Gross -= parseFloat(d.Total_Gross);
        n.Christian_Gross -= parseFloat(d.chr_value) * parseFloat(d.Total_Gross) / 100;
        return n;
    }, function(){
        return {Total_Gross: 0, Christian_Gross: 0};
    });*/

    /*var last_title = "";

    var movieDimScatter = facts.dimension(function(d) {
        return [parseFloat(d.Total_Gross), parseFloat(d.chr_value) * parseFloat(d.Total_Gross) / 100, d.Title];
    });

    var movieGrossReligionGroup = movieDimScatter.group().reduce(function(n, d) {
        n.key[2] = d[2];
        n.key[0] += d[0];
        n.key[1] += d[1];
        n.value += 1;
        return n;
    }, function(n, d) {
        n.key[2] = d[2];
        n.key[0] -= d[0];
        n.key[1] -= d[1];
        n.value -= 1;
        return n;
    }, function(){
        return {key: [], value: 0};
    });

    console.log(movieGrossReligionGroup.top(Infinity));

    chartGrossReligion
        .width(768)
        .height(480)
        .x(d3.scale.linear().domain([0.0,2000.0]))
        //.brushOn(false)
        //.symbolSize(8)
        //.clipPadding(10)
        //.yAxisLabel("This is the Y Axis!")
        .dimension(movieDimScatter)
        .group(movieGrossReligionGroup)
        //.data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        //.keyAccessor(function(d) {return d.key;})
        //.valueAccessor(function(d) {return d.value.Christian_Gross;})*/

    dc.renderAll();
}

</script>
</body>
</html>