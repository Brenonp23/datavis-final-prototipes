<!DOCTYPE html>
<!--The code is modified from: https://jasonneylon.wordpress.com/2013/09/05/two-sided-horizontal-barchart-using-d3-js/-->


<html>
<head>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>

    <title>Bar Chart</title>

    <style type="text/css">
        .chart {
            margin: 10px;
            padding-top: 10px;
        }

        .chart svg g .row text { 
            display: none; 
        }

        .right {
            width: 45%;
            position: absolute;
            right: 0;
        }

        .left {
            width: 45%;
            position: absolute;
            left: 0;
            transform: scale(-1,1);
        }

        .left text {
            transform: scale(-1,1);
        }

    </style>
</head>
<body>
<h1>Two sided horiztontal bar chart</h1>

<div id="grossChart" class="chart left"></div>

<div id="hdiChart" class="chart right"></div>

<script type="text/javascript">
var percentsByCountry = d3.map();
var grossByCountry = d3.map();

var facts;
var movieDim;
var all;
var treated_data;

//Create a quantize color scale here
// Consider that the unemployment rate goes from 0 to 15% (.15)
// display the colors in nine different levels of greens (using colorbrewer)

var chartHdi = dc.rowChart("#hdiChart");
var chartGross = dc.rowChart("#grossChart");

queue()
    // .defer(d3.tsv, "data/2016_general.csv")
    
    .defer(d3.tsv, 'data/2016_foreign.csv') 
    //   function(d) {
    //   var ctr = d.Country
    //   if (!grossByCountry.has(d.Title)){
    //     grossByCountry.set(d.Title, {ctr: parseFloat(d.Total_Gross)})
    //   }

    //   else 
    //     grossByCountry.get(d.Title)[d.Country] = parseFloat(d.Total_Gross)
   
    // })
    .defer(d3.tsv, "data/2016_countries.csv", 
      function(d) { percentsByCountry.set(d.Name, {chr: parseFloat(d.ChristianPercent),
                                                   mus: parseFloat(d.MuslimPercent),
                                                   ath: parseFloat(d.AtheistPercent),
                                                   hin: parseFloat(d.HinduPercent),
                                                   bud: parseFloat(d.BuddhistPercent),
                                                   flk: parseFloat(d.FolkReligionPercent),
                                                   oth: parseFloat(d.OtherPercent),
                                                   jew: parseFloat(d.JewishPercent),
                                                   hdi: parseFloat(d.HDI)
                                               }
                                              );})
    .await(ready);

function ready(error, data) {

    data.forEach(function(d) {
        var country_info = percentsByCountry.get(d.Country);

        d.hdi = country_info.hdi;
        d.chr_value = country_info.chr;
        d.mus_value = country_info.mus;
        d.ath_value = country_info.ath;
        d.hin_value = country_info.hin;
        d.bud_value = country_info.bud;
        d.flk_value = country_info.flk;
        d.jew_value = country_info.jew;
        d.oth_value = country_info.oth;
    });

    facts = crossfilter(data);
    all = facts.groupAll();

    //---------- Dimensions ---------------------------------

    movieDim = facts.dimension(function(d) {
        return d.Title;
    });

    var countryDim = facts.dimension(function(d) {
        return d.Country;
    })

    //--------- Groups and Charts --------------------------------------

    // Rowchart: 

    var countryHdiMax = countryDim.group().reduceCount().top(1)[0].value;
    var countryAmt = countryDim.group().reduceCount().top(Infinity).length;

    var countryHdiGrossGroup = countryDim.group().reduce(function(n, d) {
        n.Total_Gross += parseFloat(d.Total_Gross);
        n.hdi += parseFloat(d.hdi);
        return n;
    }, function(n, d) {
        n.Total_Gross -= parseFloat(d.Total_Gross);
        n.hdi -= parseFloat(d.hdi);
        return n;
    }, function(){
        return {Total_Gross: 0, hdi: 0};
    });

    countryHdiGrossGroup.top(Infinity).forEach(function(d) {
        d.value.hdi = parseFloat((d.value.hdi / countryHdiMax).toFixed(2));
    });

    chartGross
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.Total_Gross})
        .height(countryAmt * 20)
        .gap(10);

    chartHdi
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.hdi})
        .height(countryAmt * 20)
        .gap(10);


    // Piechart:


    dc.renderAll();
}

</script>
</body>
</html>