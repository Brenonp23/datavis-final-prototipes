<!DOCTYPE html>
<!--The code is modified from: https://jasonneylon.wordpress.com/2013/09/05/two-sided-horizontal-barchart-using-d3-js/-->


<html>
<head>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/dc.js" charset="utf-8"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>

    <title>Bar Chart</title>

    <style type="text/css">
        .chart {
            margin: 10px;
            padding-top: 10px;
        }

        .chart svg g .row text { 
            display: none; 
        }

        .right {
            width: 45%;
            position: absolute;
            right: 0;
        }

        .left {
            width: 45%;
            position: absolute;
            left: 0;
            transform: scale(-1,1);
        }

        .left text {
            transform: scale(-1,1);
        }

    </style>
</head>
<body>
<h1>Two sided horiztontal bar chart</h1>

<div id="grossChart" class="chart left"></div>

<div id="hdiChart" class="chart right"></div>

<script type="text/javascript">
var percentsByCountry = d3.map();
var grossByCountry = d3.map();

var facts;
var movieDim;
var all;
var treated_data;

//Create a quantize color scale here
// Consider that the unemployment rate goes from 0 to 15% (.15)
// display the colors in nine different levels of greens (using colorbrewer)

var chartHdi = dc.rowChart("#hdiChart");
var chartGross = dc.rowChart("#grossChart");

queue()
    // .defer(d3.tsv, "data/2016_general.csv")
    
    .defer(d3.tsv, 'data/2016_foreign.csv') 
    //   function(d) {
    //   var ctr = d.Country
    //   if (!grossByCountry.has(d.Title)){
    //     grossByCountry.set(d.Title, {ctr: parseFloat(d.Total_Gross)})
    //   }

    //   else 
    //     grossByCountry.get(d.Title)[d.Country] = parseFloat(d.Total_Gross)
   
    // })
    .defer(d3.tsv, "data/2016_countries.csv", 
      function(d) { percentsByCountry.set(d.Name, {chr: parseFloat(d.ChristianPercent),
                                                   mus: parseFloat(d.MuslimPercent),
                                                   ath: parseFloat(d.AtheistPercent),
                                                   hin: parseFloat(d.HinduPercent),
                                                   bud: parseFloat(d.BuddhistPercent),
                                                   flk: parseFloat(d.FolkReligionPercent),
                                                   oth: parseFloat(d.OtherPercent),
                                                   jew: parseFloat(d.JewishPercent),
                                                   hdi: parseFloat(d.HDI)
                                               }
                                              );})
    .await(ready);

function ready(error, data) {

    data.forEach(function(d) {
        var country_info = percentsByCountry.get(d.Country);

        d.hdi = country_info.hdi;
        d.chr_value = country_info.chr;
        d.mus_value = country_info.mus;
        d.ath_value = country_info.ath;
        d.hin_value = country_info.hin;
        d.bud_value = country_info.bud;
        d.flk_value = country_info.flk;
        d.jew_value = country_info.jew;
        d.oth_value = country_info.oth;
    });

    facts = crossfilter(data);
    all = facts.groupAll();

    movieDim = facts.dimension(function(d) {
        return d.Title;
    });

    console.log(movieDim.top(Infinity));

    /*hdiDim = facts.dimension(function(d) {
        return d.hdi;
    });

    hdiGroup = hdiDim.group();*/

    function reduceAdd(p, v) {
      ++p.count;
      p.total += v.total;
      return p;
    }

    function reduceRemove(p, v) {
      --p.count;
      p.total -= v.total;
      return p;
    }

    function reduceInitial() {
      return {count: 0, total: 0};
    }

    function orderValue(p) {
      return p.total;
    }

    var countryDim = facts.dimension(function(d) {
        return d.Country;
    })

    var countryHdiMax = countryDim.group().reduceCount().top(1)[0].value;
    var countryAmt = countryDim.group().reduceCount().top(Infinity).length;

    var countryHdiGrossGroup = countryDim.group().reduce(function(n, d) {
        n.Total_Gross += parseFloat(d.Total_Gross);
        n.hdi += parseFloat(d.hdi);
        return n;
    }, function(n, d) {
        n.Total_Gross -= parseFloat(d.Total_Gross);
        n.hdi -= parseFloat(d.hdi);
        return n;
    }, function(){
        return {Total_Gross: 0, hdi: 0};
    });

    countryHdiGrossGroup.top(Infinity).forEach(function(d) {
        d.value.hdi = parseFloat((d.value.hdi / countryHdiMax).toFixed(2));
    });

    chartGross
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.Total_Gross})
        .height(countryAmt * 20)
        .gap(10)

    chartHdi
        .dimension(countryDim)
        .group(countryHdiGrossGroup)
        .data(function(group) {return group.order(function(d) {return d.Total_Gross;}).top(Infinity);})
        .valueAccessor(function(d) {return d.value.hdi})
        .height(countryAmt * 20)
        .gap(10)

    dc.renderAll();

  // var countryDim = facts.dimension(function(d) {
  //     return d.Country;
  // })

  // var countryGroup = movieDim.group().reduceSum(function(d) {
  //   return parseFloat(d.Total_Gross);
  // });

  // var movieGroup = countryDim.group().reduceSum(function(d) {
  //   return parseFloat(d.Total_Gross);
  // });

  // console.log(countryGroup.top(4));
  // console.log(movieGroup.top(4));

  // moviesRowChart.width(500)
  //   .height(500)
  //   .dimension(movieDim)
  //   .group(countryGroup)

  // countriesRowChart.width(500)
  //   .height(500)
  //   .dimension(countryDim)
  //   .group(movieGroup)
  //       // .columns([
  //       //   function(d){return d.Title},
  //       //   function(d){return d.Total_Gross}
  //       // ])
  //       // .sortBy(function(d) {return d.Total_Gross})
  //       // .order(d3.descending)

  //   // Render the Charts
  // dc.renderAll();

}

    /*var labelArea = 160;
    var chart,
            width = 400,
            bar_height = 20,
            height = bar_height * 200;
    var rightOffset = width + labelArea;

    var lCol = "infant.mortality";
    var rCol = "gdp";
    var xFrom = d3.scale.linear()
            .range([0, width]);
    var xTo = d3.scale.linear()
            .range([0, width]);
    var y = d3.scale.ordinal()
            .rangeBands([20, height]);

    function render(data) {
        var chart = d3.select("body")
                .append('svg')
                .attr('class', 'chart')
                .attr('width', labelArea + width + width)
                .attr('height', height);

        xFrom.domain(d3.extent(data, function (d) {
            return d[lCol];
        }));
        xTo.domain(d3.extent(data, function (d) {
            return d[rCol];
        }));

        y.domain(data.map(function (d) {
            return d.countries;
        }));

        var yPosByIndex = function (d) {
            return y(d.countries);
        };
        chart.selectAll("rect.left")
                .data(data)
                .enter().append("rect")
                .attr("x", function (d) {
                    return width - xFrom(d[lCol]);
                })
                .attr("y", yPosByIndex)
                .attr("class", "left")
                .attr("width", function (d) {
                    return xFrom(d[lCol]);
                })
                .attr("height", y.rangeBand());
        chart.selectAll("text.leftscore")
                .data(data)
                .enter().append("text")
                .attr("x", function (d) {
                    return width - xFrom(d[lCol])-40;
                })
                .attr("y", function (d) {
                    return y(d.countries) + y.rangeBand() / 2;
                })
                .attr("dx", "20")
                .attr("dy", ".36em")
                .attr("text-anchor", "end")
                .attr('class', 'leftscore')
                .text(function(d){return d[lCol];});
        chart.selectAll("text.name")
                .data(data)
                .enter().append("text")
                .attr("x", (labelArea / 2) + width)
                .attr("y", function (d) {
                    return y(d.countries) + y.rangeBand() / 2;
                })
                .attr("dy", ".20em")
                .attr("text-anchor", "middle")
                .attr('class', 'name')
                .text(function(d){return d.countries;});

        chart.selectAll("rect.right")
                .data(data)
                .enter().append("rect")
                .attr("x", rightOffset)
                .attr("y", yPosByIndex)
                .attr("class", "right")
                .attr("width", function (d) {
                    return xTo(d[rCol]);
                })
                .attr("height", y.rangeBand());
        chart.selectAll("text.score")
                .data(data)
                .enter().append("text")
                .attr("x", function (d) {
                    return xTo(d[rCol]) + rightOffset+40;
                })
                .attr("y", function (d) {
                    return y(d.countries) + y.rangeBand() / 2;
                })
                .attr("dx", -5)
                .attr("dy", ".36em")
                .attr("text-anchor", "end")
                .attr('class', 'score')
                .text(function(d){return d[rCol];});
        chart.append("text").attr("x",width/3).attr("y", 10).attr("class","title").text("Infant Mortality");
        chart.append("text").attr("x",width/3+rightOffset).attr("y", 10).attr("class","title").text("GDP");
        chart.append("text").attr("x",width+labelArea/3).attr("y", 10).attr("class","title").text("Countries");


    }

    function type(d) {
        d["gdp"] = +d["gdp"];
        d["infant.mortality"] = +d["infant.mortality"];
        return d;
    }

    d3.csv("https://gist.githubusercontent.com/kaijiezhou/b0a1959aad60346f806a/raw/80b02e59b380ca5f86a841fb6066bc9cd147ff51/UN.csv", type, render);*/
</script>
</body>
</html>